<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Pack Break</title>
  <meta name="description" content="Crack vintage packs of MTG Alpha, Pokemon Base Set 1st Edition, and 1986 Fleer Basketball">

  <!-- Social Preview -->
  <meta property="og:title" content="Pack Breaking!">
  <meta property="og:description" content="Crack vintage packs of MTG Alpha, Pokemon Base Set, and 1986 Fleer Basketball">
  <meta property="og:image" content="https://mtg-pack-simulator.vercel.app/social-preview.jpg">
  <meta property="og:url" content="https://mtg-pack-simulator.vercel.app/swipe.html">
  <meta property="og:type" content="website">

  <!-- Twitter/X -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Pack Breaking!">
  <meta name="twitter:description" content="Crack vintage packs of MTG Alpha, Pokemon Base Set, and 1986 Fleer Basketball">
  <meta name="twitter:image" content="https://mtg-pack-simulator.vercel.app/social-preview.jpg">

  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¥</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      background: #0a0a0a;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100dvh;
      touch-action: none;
    }

    /* Fleer mode - matches standalone fleer-1986.html */
    body.fleer-mode .splash-screen {
      background: linear-gradient(180deg, #f5f5f0 0%, #e8e4dc 100%);
      padding: 40px 30px 180px 30px;
    }

    body.fleer-mode .splash-logo {
      width: 85vw;
      max-width: 360px;
      margin-bottom: 20px;
      mix-blend-mode: multiply;
      filter: none;
    }

    body.fleer-mode .splash-description {
      font-size: 16px;
      line-height: 1.7;
      color: rgba(0,0,0,0.6);
      max-width: 320px;
      margin-top: -159px;
      margin-bottom: 26px;
    }

    body.fleer-mode .splash-hint {
      color: rgba(0,0,0,0.35);
    }

    body.fleer-mode .tap-icon {
      border-color: rgba(0,0,0,0.25);
    }

    body.fleer-mode .tap-icon::after {
      background: rgba(0,0,0,0.3);
    }

    body.fleer-mode .mode-link {
      color: rgba(0,0,0,0.4);
    }

    body.fleer-mode .total-value {
      color: rgba(0,0,0,0.4);
    }


    /* Full-screen app container */
    .app {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* Splash/intro screen */
    .splash-screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 30px;
      text-align: center;
      opacity: 1;
      transition: opacity 0.4s ease;
    }

    .splash-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .splash-logo {
      width: 80vw;
      max-width: 340px;
      margin-bottom: 35px;
      filter: drop-shadow(0 4px 30px rgba(0,0,0,0.6));
    }


    .splash-description {
      font-size: 15px;
      line-height: 1.65;
      color: rgba(255,255,255,0.6);
      max-width: 310px;
      margin-bottom: 45px;
    }

    .splash-hint {
      font-size: 13px;
      color: rgba(255,255,255,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .tap-icon {
      width: 40px;
      height: 40px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      position: relative;
      animation: tapPulse 2s ease-in-out infinite;
    }

    .tap-icon::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 12px;
      height: 12px;
      background: rgba(255,255,255,0.4);
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    @keyframes tapPulse {
      0%, 100% {
        transform: scale(1);
        opacity: 0.4;
      }
      50% {
        transform: scale(1.15);
        opacity: 1;
      }
    }

    /* Pack display - full screen focus */
    .pack-screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }

    .pack-screen.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .pack-screen.hidden {
      display: none;
    }

    .pack {
      width: 75vw;
      max-width: 300px;
      aspect-ratio: 5/7;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 80px rgba(0,0,0,0.6);
      transition: transform 0.2s ease;
      will-change: transform;
    }

    .pack img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
    }

    /* Pokemon pack - different aspect ratio */
    .pack.pokemon-pack {
      aspect-ratio: 2/3;
    }

    .pack.pokemon-pack img {
      object-fit: contain;
    }

    /* Fleer pack - wax pack aspect ratio */
    .pack.fleer-pack {
      aspect-ratio: 318/439;
    }

    .pack.fleer-pack img {
      object-fit: contain;
    }

    /* Fleer card styling - basketball card proportions */
    .card.fleer-card img,
    .card-next.fleer-card img {
      border-radius: 8px;
    }

    /* Fleer price at top right to avoid player names */
    .card.fleer-card .card-value {
      bottom: auto;
      top: 12px;
      left: auto;
      right: 12px;
      transform: none;
      font-size: 16px;
      padding: 6px 12px;
    }

    .pack-hint {
      font-size: 14px;
      color: rgba(255,255,255,0.4);
      text-align: center;
    }

    .pack-hint .arrow {
      display: block;
      font-size: 24px;
      margin-bottom: 8px;
      animation: bounceUp 1.5s ease-in-out infinite;
    }

    @keyframes bounceUp {
      0%, 100% { transform: translateY(0); opacity: 0.4; }
      50% { transform: translateY(-8px); opacity: 1; }
    }

    /* Pack tear animation */
    @keyframes packTear {
      0% {
        clip-path: inset(0 0 0 0);
        transform: scale(1);
        filter: brightness(1);
      }
      30% {
        clip-path: inset(0 0 30% 0);
        transform: scale(1.05) translateY(-15px);
        filter: brightness(1.3);
      }
      100% {
        clip-path: inset(0 0 100% 0);
        transform: scale(1.1) translateY(-40px);
        opacity: 0;
      }
    }

    .pack.tearing {
      animation: packTear 0.5s ease-out forwards;
    }

    /* Card area */
    .card-screen {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .card-screen.active {
      display: flex;
    }

    /* The main swipeable card */
    .card-wrapper {
      position: relative;
      width: 85vw;
      max-width: 380px;
      aspect-ratio: 5/7;
    }

    /* Next card - sits underneath, revealed as you swipe */
    .card-next {
      position: absolute;
      inset: 0;
      border-radius: 16px;
      overflow: hidden;
      background: transparent;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      transform: scale(0.92);
      filter: brightness(0.7);
      transition: transform 0.3s ease, filter 0.3s ease;
      z-index: 1;
      visibility: hidden;
    }

    .card-next img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      clip-path: inset(2% round 4%);
    }

    .card-next.peeking {
      transition: none;
    }

    .card-next.rare {
      box-shadow: 0 0 40px rgba(255, 215, 0, 0.3), 0 10px 30px rgba(0,0,0,0.4);
    }

    .card-next.power9 {
      box-shadow: 0 0 50px rgba(147, 51, 234, 0.4), 0 0 80px rgba(255, 215, 0, 0.2);
    }

    /* Current card - on top */
    .card {
      position: absolute;
      inset: 0;
      border-radius: 16px;
      overflow: hidden;
      background: transparent;
      box-shadow: 0 15px 50px rgba(0,0,0,0.5);
      will-change: transform;
      z-index: 2;
    }

    .card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
      clip-path: inset(2% round 4%);
    }

    .card.dragging {
      transition: none !important;
    }

    /* Card value overlay - subtle on card */
    .card-value {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 10px 20px;
      border-radius: 24px;
      font-size: 20px;
      font-weight: 700;
      color: #4ade80;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .card-value.visible {
      opacity: 1;
    }

    /* Rarity glow */
    .card.rare {
      box-shadow: 0 0 60px rgba(255, 215, 0, 0.4), 0 15px 50px rgba(0,0,0,0.5);
    }

    .card.power9 {
      box-shadow: 0 0 80px rgba(147, 51, 234, 0.5), 0 0 120px rgba(255, 215, 0, 0.3);
    }

    /* Card animations */
    @keyframes cardDeal {
      0% {
        transform: scale(0.5) translateY(100px) rotate(10deg);
        opacity: 0;
      }
      70% {
        transform: scale(1.05) translateY(-10px) rotate(-2deg);
      }
      100% {
        transform: scale(1) translateY(0) rotate(0);
        opacity: 1;
      }
    }

    @keyframes rareDeal {
      0% {
        transform: scale(0.3) rotateY(180deg);
        opacity: 0;
        filter: brightness(2);
      }
      50% {
        transform: scale(1.1) rotateY(0);
        filter: brightness(1.5);
      }
      100% {
        transform: scale(1);
        opacity: 1;
        filter: brightness(1);
      }
    }

    @keyframes power9Deal {
      0% {
        transform: scale(0.1) rotateY(360deg) rotateX(20deg);
        opacity: 0;
        filter: brightness(3) saturate(2);
      }
      40% {
        transform: scale(1.2) rotateY(0) rotateX(0);
        filter: brightness(2) saturate(1.5);
      }
      70% {
        transform: scale(0.95);
      }
      100% {
        transform: scale(1);
        opacity: 1;
        filter: brightness(1) saturate(1);
      }
    }

    .card.deal-normal {
      animation: cardDeal 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .card.deal-rare {
      animation: rareDeal 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .card.deal-power9 {
      animation: power9Deal 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes swipeOut {
      to {
        transform: var(--swipe-transform);
        opacity: 0;
      }
    }

    .card.swipe-out {
      animation: swipeOut 0.25s ease-out forwards;
    }

    /* Progress dots */
    .progress-dots {
      position: fixed;
      bottom: max(20px, env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 6px;
      padding: 10px 16px;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .progress-dots.visible {
      opacity: 1;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      transition: all 0.2s ease;
    }

    .dot.revealed {
      background: var(--color-gold, #d4af37);
    }

    .dot.current {
      background: #fff;
      transform: scale(1.4);
    }

    .dot.rare-dot {
      background: linear-gradient(135deg, #ffd700, #ff8c00);
    }

    /* Swipe direction indicators */
    .swipe-indicator {
      position: fixed;
      font-size: 32px;
      opacity: 0;
      transition: opacity 0.15s ease;
      pointer-events: none;
      z-index: 10;
    }

    .swipe-indicator.right { right: 16px; top: 50%; transform: translateY(-50%); }
    .swipe-indicator.up { top: 80px; left: 50%; transform: translateX(-50%); }
    .swipe-indicator.down { bottom: 100px; left: 50%; transform: translateX(-50%); }
    .swipe-indicator.visible { opacity: 0.6; }

    /* Bottom sheet */
    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 100;
    }

    .sheet-backdrop.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 75vh;
      background: #1a1a1a;
      border-radius: 24px 24px 0 0;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 101;
      overflow: hidden;
    }

    .bottom-sheet.open {
      transform: translateY(0);
    }

    .sheet-handle {
      width: 40px;
      height: 4px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      margin: 12px auto;
    }

    .sheet-content {
      padding: 0 20px calc(20px + env(safe-area-inset-bottom));
      max-height: calc(75vh - 30px);
      overflow-y: auto;
    }

    .sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .sheet-title {
      font-size: 18px;
      font-weight: 700;
    }

    .sheet-value {
      font-size: 22px;
      font-weight: 800;
      color: #4ade80;
    }

    .sheet-cards {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }

    .mini-card {
      aspect-ratio: 5/7;
      border-radius: 8px;
      overflow: hidden;
      background: #2a2a2a;
      transition: transform 0.15s ease;
    }

    .mini-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      clip-path: inset(2% round 3%);
    }

    .mini-card.empty {
      border: 1px dashed rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.05);
    }

    .mini-card.empty:active {
      background: rgba(255,255,255,0.15);
      transform: scale(0.95);
    }

    .mini-card.rare-mini {
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
    }

    .mini-card:not(.empty):active {
      transform: scale(0.95);
    }

    .sheet-actions {
      display: flex;
      gap: 12px;
    }

    .sheet-btn {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s ease;
    }

    .sheet-btn:active {
      transform: scale(0.97);
    }

    .sheet-btn.primary {
      background: linear-gradient(135deg, #d4af37, #b8960c);
      color: #000;
    }

    .sheet-btn.secondary {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    /* Card details overlay */
    .card-details {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 200;
    }

    .card-details.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .card-details img {
      max-height: 55vh;
      max-width: 90vw;
      border-radius: 16px;
      margin-bottom: 24px;
      clip-path: inset(2% round 4%);
    }

    .detail-name {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 8px;
      text-align: center;
    }

    .detail-set {
      font-size: 14px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 12px;
    }

    .detail-price {
      font-size: 32px;
      font-weight: 800;
      color: #4ade80;
    }

    .detail-hint {
      position: absolute;
      bottom: max(30px, env(safe-area-inset-bottom));
      font-size: 13px;
      color: rgba(255,255,255,0.3);
    }

    /* Screen flash effects */
    .screen-flash {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 500;
    }

    .screen-flash.rare-flash {
      background: radial-gradient(circle, rgba(255,215,0,0.4) 0%, transparent 70%);
      animation: flash 0.5s ease-out forwards;
    }

    .screen-flash.power9-flash {
      background: radial-gradient(circle, rgba(147,51,234,0.5) 0%, rgba(255,215,0,0.3) 40%, transparent 70%);
      animation: flash 0.8s ease-out forwards;
    }

    @keyframes flash {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Link back */
    .mode-link {
      position: fixed;
      top: max(12px, env(safe-area-inset-top));
      left: 16px;
      font-size: 13px;
      color: rgba(255,255,255,0.4);
      text-decoration: none;
      z-index: 50;
    }

    /* Running total value */
    .total-value {
      position: fixed;
      top: max(12px, env(safe-area-inset-top));
      right: 16px;
      font-size: 13px;
      color: rgba(255,255,255,0.4);
      z-index: 50;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .total-value.visible {
      opacity: 1;
    }

    .total-value .label {
      margin-right: 4px;
    }

    .total-value .amount {
      color: #4ade80;
      font-weight: 600;
    }

    /* First card swipe hint */
    .swipe-hint {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      border-radius: 16px;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .swipe-hint.visible {
      opacity: 1;
    }

    .swipe-hint .hint-arrow {
      font-size: 36px;
      color: rgba(255,255,255,0.8);
      animation: swipeUpHint 1.2s ease-in-out infinite;
    }

    .swipe-hint .hint-text {
      font-size: 14px;
      color: rgba(255,255,255,0.6);
      margin-top: 12px;
    }

    @keyframes swipeUpHint {
      0%, 100% {
        transform: translateY(10px);
        opacity: 0.5;
      }
      50% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    /* Chase card glow (Pokemon) */
    .card.chase {
      box-shadow: 0 0 80px rgba(255, 140, 0, 0.5), 0 0 120px rgba(255, 215, 0, 0.3);
    }

    .card-next.chase {
      box-shadow: 0 0 50px rgba(255, 140, 0, 0.4), 0 0 80px rgba(255, 215, 0, 0.2);
    }

    /* Pokemon card - no white border crop needed */
    .card.pokemon-card img,
    .card-next.pokemon-card img {
      clip-path: none;
    }
  </style>
</head>
<body>
  <a href="#" class="mode-link" id="backLink">‚Üê Back</a>
  <div class="total-value" id="totalValue">
    <span class="label">Total</span>
    <span class="amount" id="totalAmount">$0</span>
  </div>

  <div class="app">
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
      <img src="mtg-logo.png" alt="Logo" class="splash-logo" id="splashLogo">
      <div class="splash-description" id="splashDescription">
        Premiering in August 1993, Limited Edition Alpha was the first Magic: The Gathering set. The one that started it all.
      </div>
      <div class="splash-hint">
        <div class="tap-icon"></div>
        Tap to continue
      </div>
    </div>

    <!-- Pack Screen -->
    <div class="pack-screen" id="packScreen">
      <div class="pack" id="pack">
        <img src="booster-pack-art.png" alt="Booster Pack" id="packImage">
      </div>
      <div class="pack-hint">
        <span class="arrow">‚Üë</span>
        Swipe up to open
      </div>
    </div>

    <!-- Card Screen -->
    <div class="card-screen" id="cardScreen">
      <div class="card-wrapper" id="cardWrapper">
        <!-- Next card preview (underneath) -->
        <div class="card-next" id="cardNext">
          <img src="" alt="Next Card" id="cardNextImg">
        </div>
        <!-- Current card (on top) -->
        <div class="card" id="card">
          <img src="" alt="Card" id="cardImg">
          <div class="card-value" id="cardValue">$0</div>
          <div class="swipe-hint" id="swipeHint">
            <span class="hint-arrow">‚Üë</span>
            <span class="hint-text">Swipe up to reveal</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Swipe indicators -->
    <div class="swipe-indicator right" id="indRight">‚Üí</div>
    <div class="swipe-indicator up" id="indUp">‚Üë</div>
    <div class="swipe-indicator down" id="indDown">‚Üì</div>

    <!-- Progress dots -->
    <div class="progress-dots" id="progressDots"></div>
  </div>

  <!-- Card details overlay -->
  <div class="card-details" id="cardDetails">
    <img src="" alt="" id="detailImg">
    <div class="detail-name" id="detailName">Card Name</div>
    <div class="detail-set" id="detailSet">Alpha</div>
    <div class="detail-price" id="detailPrice">$0</div>
    <div class="detail-hint">Tap to dismiss</div>
  </div>

  <!-- Bottom sheet -->
  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="bottom-sheet" id="bottomSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-content">
      <div class="sheet-header">
        <div class="sheet-title" id="sheetTitle">Pack Progress</div>
        <div class="sheet-value" id="sheetValue">$0</div>
      </div>
      <div class="sheet-cards" id="sheetCards"></div>
      <div class="sheet-actions">
        <button class="sheet-btn secondary" id="btnContinue">Continue</button>
        <button class="sheet-btn primary" id="btnNewPack" style="display:none;">New Pack</button>
      </div>
    </div>
  </div>

  <!-- Screen flash -->
  <div class="screen-flash" id="screenFlash"></div>

  <script src="card-data.js?v=20260123"></script>
  <script src="price-data.js?v=20260123"></script>
  <script src="pokemon-data.js?v=20260123"></script>
  <script src="fleer-1986-data.js?v=20260123"></script>
  <script>
    // ==================== GAME CONFIG ====================
    const GAME_CONFIG = {
      mtg: {
        name: 'Magic: The Gathering',
        setName: 'Alpha',
        logo: 'mtg-logo.png',
        packArt: 'booster-pack-art.png',
        description: 'Premiering in August 1993, Limited Edition Alpha was the first Magic: The Gathering set. The one that started it all.',
        packSize: { commons: 11, uncommons: 3, rares: 1 },
        chaseKey: 'isPowerNine',
        chaseLabel: 'Power 9'
      },
      pokemon: {
        name: 'Pokemon',
        setName: 'Base Set 1st Edition',
        logo: 'pokemon-logo.png',
        packArt: 'pokemon-pack-charizard.jpg',
        description: 'The original 1999 Pokemon Base Set that started the global phenomenon. Chase the legendary Charizard.',
        packSize: { commons: 7, uncommons: 3, rares: 1 },
        chaseKey: 'isChase',
        chaseLabel: 'Chase'
      },
      fleer: {
        name: '1986-87 Fleer Basketball',
        setName: '1986-87 Fleer',
        logo: 'fleer-logo.png',
        packArt: 'fleer-pack.webp',
        description: 'The most iconic basketball card set ever. 132 cards featuring Michael Jordan\'s legendary rookie card.',
        packSize: { cards: 12, stickers: 1 },
        chaseKey: 'isJordan',
        chaseLabel: 'Jordan RC'
      }
    };

    // ==================== STATE ====================
    const state = {
      gameMode: 'mtg',
      cards: [],
      currentIndex: 0,
      packValue: 0,
      revealed: [],
      showingSplash: true,
      isAnimating: false,
      isDragging: false,
      packOpened: false,
      packComplete: false,
      sheetOpen: false,
      detailsOpen: false,
      touchStartX: 0,
      touchStartY: 0,
      touchCurrentX: 0,
      touchCurrentY: 0,
      touchStartTime: 0
    };

    // ==================== ELEMENTS ====================
    const els = {
      splashScreen: document.getElementById('splashScreen'),
      splashLogo: document.getElementById('splashLogo'),
      splashDescription: document.getElementById('splashDescription'),
      packScreen: document.getElementById('packScreen'),
      pack: document.getElementById('pack'),
      packImage: document.getElementById('packImage'),
      cardScreen: document.getElementById('cardScreen'),
      cardWrapper: document.getElementById('cardWrapper'),
      card: document.getElementById('card'),
      cardImg: document.getElementById('cardImg'),
      cardValue: document.getElementById('cardValue'),
      cardNext: document.getElementById('cardNext'),
      cardNextImg: document.getElementById('cardNextImg'),
      progressDots: document.getElementById('progressDots'),
      indRight: document.getElementById('indRight'),
      indUp: document.getElementById('indUp'),
      indDown: document.getElementById('indDown'),
      cardDetails: document.getElementById('cardDetails'),
      detailImg: document.getElementById('detailImg'),
      detailName: document.getElementById('detailName'),
      detailSet: document.getElementById('detailSet'),
      detailPrice: document.getElementById('detailPrice'),
      sheetBackdrop: document.getElementById('sheetBackdrop'),
      bottomSheet: document.getElementById('bottomSheet'),
      sheetTitle: document.getElementById('sheetTitle'),
      sheetValue: document.getElementById('sheetValue'),
      sheetCards: document.getElementById('sheetCards'),
      btnContinue: document.getElementById('btnContinue'),
      btnNewPack: document.getElementById('btnNewPack'),
      screenFlash: document.getElementById('screenFlash'),
      totalValue: document.getElementById('totalValue'),
      totalAmount: document.getElementById('totalAmount'),
      swipeHint: document.getElementById('swipeHint'),
      backLink: document.getElementById('backLink')
    };

    // ==================== UTILITIES ====================
    function pickRandom(arr, count) {
      const result = [];
      const used = new Set();
      while (result.length < count && used.size < arr.length) {
        const i = Math.floor(Math.random() * arr.length);
        if (!used.has(i)) {
          used.add(i);
          result.push({...arr[i]});
        }
      }
      return result;
    }

    function generatePack() {
      const config = GAME_CONFIG[state.gameMode];

      if (state.gameMode === 'fleer') {
        // 1986 Fleer: 12 random cards + 1 sticker
        // Sort by price: commons first, stars last (authentic pack order)
        const cards = pickRandom(FLEER_1986.cards, 12);
        cards.sort((a, b) => a.price - b.price);
        cards.forEach(c => {
          c.rarity = c.rookie ? 'rookie' : 'base';
          c.isJordan = c.name === 'Michael Jordan';
        });
        const sticker = pickRandom(FLEER_1986.stickers, 1)[0];
        sticker.isSticker = true;
        sticker.rarity = 'sticker';
        sticker.isJordan = sticker.name.includes('Michael Jordan');
        return [...cards, sticker];
      }

      if (state.gameMode === 'pokemon') {
        const pool = POKEMON_BASE_SET;
        if (!pool) return [];

        const { commons, uncommons, rares } = config.packSize;

        const commonCards = pickRandom(pool.commons, commons);
        commonCards.forEach(c => c.rarity = 'common');

        const uncommonCards = pickRandom(pool.uncommons, uncommons);
        uncommonCards.forEach(c => c.rarity = 'uncommon');

        // Pokemon holo rare chance (~33%)
        let rareCard;
        if (pool.holoRares && Math.random() < 0.33) {
          rareCard = pickRandom(pool.holoRares, 1)[0];
          rareCard.rarity = 'holo';
          rareCard.isChase = POKEMON_BASE_SET.chaseCards.includes(rareCard.name);
        } else {
          rareCard = pickRandom(pool.rares, 1)[0];
          rareCard.rarity = 'rare';
        }

        return [...commonCards, ...uncommonCards, rareCard];
      }

      // MTG
      const pool = ALPHA_CARDS;
      if (!pool) return [];

      const { commons: cCount, uncommons: uCount, rares: rCount } = config.packSize;

      const commons = pickRandom(pool.commons, cCount);
      commons.forEach(c => c.rarity = 'common');

      const uncommons = pickRandom(pool.uncommons, uCount);
      uncommons.forEach(c => c.rarity = 'uncommon');

      const rare = pickRandom(pool.rares, rCount)[0];
      rare.rarity = 'rare';

      return [...commons, ...uncommons, rare];
    }

    function getPrice(cardName, rarity) {
      if (state.gameMode === 'fleer') {
        // Fleer pricing from data file
        if (typeof getFleerCardPrice === 'function') {
          const p = getFleerCardPrice(cardName);
          if (p !== null) return p;
        }
        // Fleer defaults
        const defaults = { rookie: 20, base: 5, sticker: 10 };
        return defaults[rarity] || 5;
      }

      if (state.gameMode === 'pokemon') {
        // Try specific Pokemon card price
        if (typeof getPokemonCardPrice === 'function') {
          const p = getPokemonCardPrice(cardName);
          if (p !== null) return p;
        }
        // Pokemon rarity defaults
        const defaults = { holo: 1500, rare: 100, uncommon: 30, common: 15 };
        return defaults[rarity] || 15;
      }

      // MTG pricing
      if (typeof getCardPrice === 'function') {
        const p = getCardPrice(cardName, 'lea');
        if (p !== null) return p;
      }
      if (typeof getDefaultPrice === 'function') {
        return getDefaultPrice('lea', rarity || 'common');
      }
      const defaults = { common: 150, uncommon: 400, rare: 1500 };
      return defaults[rarity] || 150;
    }

    function formatPrice(price) {
      if (price >= 1000) return '$' + (price / 1000).toFixed(1) + 'k';
      if (price >= 1) return '$' + price.toFixed(0);
      return '$' + price.toFixed(2);
    }

    function getImageUrl(card) {
      if (state.gameMode === 'fleer') {
        // Fleer uses local images
        if (card.isSticker) {
          return `fleer-stickers/${card.number}.jpg`;
        }
        return `fleer-cards/${card.number}.jpg`;
      }
      if (state.gameMode === 'pokemon') {
        // Pokemon TCG API uses card number (e.g., "4/102" ‚Üí "4")
        const num = card.number ? card.number.split('/')[0] : '1';
        return `https://images.pokemontcg.io/base1/${num}_hires.png`;
      }
      // MTG Scryfall - card can be string (name) or object
      const cardName = typeof card === 'string' ? card : card.name;
      return `https://api.scryfall.com/cards/named?exact=${encodeURIComponent(cardName)}&set=lea&format=image&version=normal`;
    }

    function haptic(type) {
      if (!navigator.vibrate) return;
      switch (type) {
        case 'light': navigator.vibrate(10); break;
        case 'medium': navigator.vibrate([30, 20, 50]); break;
        case 'heavy': navigator.vibrate([50, 30, 100]); break;
        case 'power9': navigator.vibrate([100, 50, 100, 50, 200]); break;
      }
    }

    // ==================== SPLASH SCREEN ====================
    function dismissSplash() {
      if (!state.showingSplash) return;
      state.showingSplash = false;

      els.splashScreen.classList.add('hidden');
      els.packScreen.classList.add('visible');

      haptic('light');
    }

    // ==================== MODE SWITCHING ====================
    function switchGameMode() {
      // Cycle through: mtg -> pokemon -> fleer -> mtg
      const modes = ['mtg', 'pokemon', 'fleer'];
      const currentIndex = modes.indexOf(state.gameMode);
      state.gameMode = modes[(currentIndex + 1) % modes.length];
      updateUIForMode();
      initPack(); // Re-generate pack for new mode
      haptic('medium');
    }

    function goBackToSplash() {
      // Reset all state
      state.showingSplash = true;
      state.packOpened = false;
      state.packComplete = false;
      state.isAnimating = false;
      state.sheetOpen = false;
      state.detailsOpen = false;

      // Hide everything and show splash
      els.cardScreen.classList.remove('active');
      els.packScreen.classList.remove('visible', 'hidden');
      els.splashScreen.classList.remove('hidden');
      els.pack.classList.remove('tearing');
      els.pack.style.transform = '';
      els.progressDots.classList.remove('visible');
      els.card.classList.remove('rare', 'power9', 'chase', 'pokemon-card', 'fleer-card', 'deal-normal', 'deal-rare', 'deal-power9', 'swipe-out');
      els.cardValue.classList.remove('visible');
      els.cardNext.style.visibility = 'hidden';
      els.cardNext.classList.remove('rare', 'power9', 'chase', 'peeking', 'pokemon-card');
      els.cardNext.style.transform = '';
      els.cardNext.style.filter = '';
      els.totalValue.classList.remove('visible');
      els.totalAmount.textContent = '$0';
      els.swipeHint.classList.remove('visible');
      els.bottomSheet.classList.remove('open');
      els.sheetBackdrop.classList.remove('visible');
      els.cardDetails.classList.remove('visible');

      // Re-init pack for current mode
      updateUIForMode();
      initPack();
    }

    function updateUIForMode() {
      const config = GAME_CONFIG[state.gameMode];
      els.splashLogo.src = config.logo;
      els.splashDescription.textContent = config.description;
      els.packImage.src = config.packArt;

      // Update pack styling for different aspect ratios
      els.pack.classList.remove('pokemon-pack', 'fleer-pack');
      if (state.gameMode === 'pokemon') els.pack.classList.add('pokemon-pack');
      if (state.gameMode === 'fleer') els.pack.classList.add('fleer-pack');

      // Fleer mode uses cream background
      document.body.classList.toggle('fleer-mode', state.gameMode === 'fleer');
    }

    // ==================== PACK OPENING ====================
    function initPack() {
      state.cards = generatePack();
      state.currentIndex = 0;
      state.packValue = 0;
      state.revealed = [];
      state.packOpened = false;
      state.packComplete = false;
      createProgressDots();
    }

    function createProgressDots() {
      els.progressDots.innerHTML = '';
      state.cards.forEach((_, i) => {
        const dot = document.createElement('div');
        dot.className = 'dot';
        if (i === state.cards.length - 1) dot.classList.add('rare-dot');
        els.progressDots.appendChild(dot);
      });
    }

    function tearOpenPack() {
      if (state.isAnimating) return;
      state.isAnimating = true;
      haptic('medium');

      els.pack.classList.add('tearing');

      // Pre-load first two cards before transition
      const firstCard = state.cards[0];
      els.cardImg.src = getImageUrl(firstCard);

      setTimeout(() => {
        state.packOpened = true;
        els.packScreen.classList.add('hidden');
        els.cardScreen.classList.add('active');
        els.progressDots.classList.add('visible');
        els.totalValue.classList.add('visible');
        showCard(0);
      }, 500);
    }

    // ==================== CARD DISPLAY ====================
    function showCard(index, skipAnimation = false) {
      if (index >= state.cards.length) {
        finishPack();
        return;
      }

      const card = state.cards[index];
      const price = getPrice(card.name, card.rarity);
      card.price = price;

      state.currentIndex = index;
      state.packValue += price;
      state.revealed.push(card);

      // Update running total
      els.totalAmount.textContent = formatPrice(state.packValue);

      // Update card display
      els.cardImg.src = getImageUrl(card);
      els.cardValue.textContent = formatPrice(price);

      // Pre-load next card underneath for peek effect
      preloadNextCard(index + 1);

      // Determine animation type
      const config = GAME_CONFIG[state.gameMode];
      const isChase = card[config.chaseKey] || card.isChase;
      const isRare = card.rarity === 'rare' || card.rarity === 'holo';
      const isLastCard = index === state.cards.length - 1;

      // Apply rarity class
      els.card.classList.remove('rare', 'power9', 'chase', 'deal-normal', 'deal-rare', 'deal-power9', 'swipe-out', 'pokemon-card', 'fleer-card');
      if (state.gameMode === 'pokemon') els.card.classList.add('pokemon-card');
      if (state.gameMode === 'fleer') els.card.classList.add('fleer-card');
      if (isChase) {
        els.card.classList.add(state.gameMode === 'mtg' ? 'power9' : 'chase');
      } else if (isRare) {
        els.card.classList.add('rare');
      }

      // Reset next card preview state
      els.cardNext.classList.remove('peeking');
      els.cardNext.style.transform = '';
      els.cardNext.style.filter = '';

      if (skipAnimation) {
        // Skip animation when promoting from preview
        els.cardValue.classList.add('visible');
        state.isAnimating = false;
        updateProgressDots(index);
        return;
      }

      // Animate in
      requestAnimationFrame(() => {
        if (isChase) {
          els.card.classList.add('deal-power9');
          flashScreen('power9');
          haptic('power9');
        } else if (isRare || isLastCard) {
          els.card.classList.add('deal-rare');
          flashScreen('rare');
          haptic('heavy');
        } else {
          els.card.classList.add('deal-normal');
          haptic('light');
        }
      });

      // Show value after animation
      const delay = isChase ? 1000 : isRare ? 700 : 400;
      setTimeout(() => {
        els.cardValue.classList.add('visible');
        state.isAnimating = false;

        // Show swipe hint on first card only
        if (index === 0) {
          els.swipeHint.classList.add('visible');
        }
      }, delay);

      updateProgressDots(index);
    }

    function preloadNextCard(nextIndex) {
      if (nextIndex >= state.cards.length) {
        // No more cards - hide preview
        els.cardNext.style.visibility = 'hidden';
        return;
      }

      const nextCard = state.cards[nextIndex];
      els.cardNext.style.visibility = 'visible';
      els.cardNextImg.src = getImageUrl(nextCard);

      // Apply rarity glow to preview
      const config = GAME_CONFIG[state.gameMode];
      const isChase = nextCard[config.chaseKey] || nextCard.isChase;
      els.cardNext.classList.remove('rare', 'power9', 'chase', 'pokemon-card', 'fleer-card');
      if (state.gameMode === 'pokemon') els.cardNext.classList.add('pokemon-card');
      if (state.gameMode === 'fleer') els.cardNext.classList.add('fleer-card');
      if (isChase) {
        els.cardNext.classList.add(state.gameMode === 'mtg' ? 'power9' : 'chase');
      } else if (nextCard.rarity === 'rare' || nextCard.rarity === 'holo') {
        els.cardNext.classList.add('rare');
      }
    }

    function updateNextCardPeek(progress) {
      // progress: 0 = no swipe, 1 = full swipe threshold
      // Scale from 0.92 to 1, brightness from 0.7 to 1
      const scale = 0.92 + (0.08 * progress);
      const brightness = 0.7 + (0.3 * progress);

      els.cardNext.classList.add('peeking');
      els.cardNext.style.transform = `scale(${scale})`;
      els.cardNext.style.filter = `brightness(${brightness})`;
    }

    function resetCardPosition() {
      // Snap current card back
      els.card.style.transition = 'transform 0.25s ease';
      els.card.style.transform = '';

      // Snap next card back to preview state
      els.cardNext.classList.remove('peeking');
      els.cardNext.style.transition = 'transform 0.25s ease, filter 0.25s ease';
      els.cardNext.style.transform = 'scale(0.92)';
      els.cardNext.style.filter = 'brightness(0.7)';

      setTimeout(() => {
        els.card.style.transition = '';
        els.cardNext.style.transition = '';
      }, 250);
    }

    function updateProgressDots(currentIdx) {
      const dots = els.progressDots.querySelectorAll('.dot');
      dots.forEach((dot, i) => {
        dot.classList.remove('current', 'revealed');
        if (i < currentIdx) dot.classList.add('revealed');
        else if (i === currentIdx) dot.classList.add('current');
      });
    }

    function swipeCardOut(direction) {
      state.isAnimating = true;
      els.cardValue.classList.remove('visible');

      // Animate next card to full size immediately
      els.cardNext.classList.remove('peeking');
      els.cardNext.style.transition = 'transform 0.25s ease-out, filter 0.25s ease-out';
      els.cardNext.style.transform = 'scale(1)';
      els.cardNext.style.filter = 'brightness(1)';

      // Set swipe direction for current card
      let transform;
      if (direction === 'up') {
        transform = 'translateY(-120vh) rotate(5deg)';
      } else {
        transform = 'translateX(-120vw) rotate(-15deg)';
      }

      els.card.style.setProperty('--swipe-transform', transform);
      els.card.classList.add('swipe-out');

      // Haptic for the next card reveal
      const nextCard = state.cards[state.currentIndex + 1];
      if (nextCard) {
        const config = GAME_CONFIG[state.gameMode];
        const nextIsChase = nextCard[config.chaseKey] || nextCard.isChase;
        if (nextIsChase) {
          haptic('power9');
          flashScreen('power9');
        } else if (nextCard.rarity === 'rare' || nextCard.rarity === 'holo' || state.currentIndex + 1 === state.cards.length - 1) {
          haptic('heavy');
          flashScreen('rare');
        } else {
          haptic('light');
        }
      }

      setTimeout(() => {
        els.card.classList.remove('swipe-out');
        els.card.style.transform = '';

        // Promote next card: copy its image to current card
        const nextIndex = state.currentIndex + 1;
        if (nextIndex < state.cards.length) {
          const nextCard = state.cards[nextIndex];
          els.cardImg.src = getImageUrl(nextCard);

          // Apply rarity to current card
          const config = GAME_CONFIG[state.gameMode];
          const nextIsChase = nextCard[config.chaseKey] || nextCard.isChase;
          els.card.classList.remove('rare', 'power9', 'chase');
          if (nextIsChase) {
            els.card.classList.add(state.gameMode === 'mtg' ? 'power9' : 'chase');
          } else if (nextCard.rarity === 'rare' || nextCard.rarity === 'holo') {
            els.card.classList.add('rare');
          }
        }

        // Update state and show card (skip animation since we already showed it)
        showCard(state.currentIndex + 1, true);

        // Reset next card transition
        setTimeout(() => {
          els.cardNext.style.transition = '';
        }, 50);
      }, 250);
    }

    function flashScreen(type) {
      els.screenFlash.className = 'screen-flash ' + type + '-flash';
      setTimeout(() => {
        els.screenFlash.className = 'screen-flash';
      }, type === 'power9' ? 800 : 500);
    }

    function finishPack() {
      state.packComplete = true;
      state.isAnimating = false;

      // Mark all dots revealed
      const dots = els.progressDots.querySelectorAll('.dot');
      dots.forEach(dot => {
        dot.classList.remove('current');
        dot.classList.add('revealed');
      });

      setTimeout(() => {
        showSheet(true);
      }, 300);
    }

    // ==================== BOTTOM SHEET ====================
    function showSheet(isComplete = false) {
      state.sheetOpen = true;

      // Update content
      els.sheetTitle.textContent = isComplete ? 'Pack Complete!' : 'Pack Progress';
      els.sheetValue.textContent = formatPrice(state.packValue);

      // Build mini cards grid
      renderSheetCards();

      // Show/hide buttons
      if (isComplete) {
        els.btnNewPack.style.display = 'block';
        els.btnContinue.textContent = 'View Cards';
      } else {
        els.btnNewPack.style.display = 'none';
        els.btnContinue.textContent = 'Continue';
      }

      els.sheetBackdrop.classList.add('visible');
      els.bottomSheet.classList.add('open');
    }

    function renderSheetCards() {
      els.sheetCards.innerHTML = '';
      for (let i = 0; i < state.cards.length; i++) {
        const mini = document.createElement('div');
        mini.className = 'mini-card';
        if (state.revealed[i]) {
          const card = state.revealed[i];
          const img = document.createElement('img');
          img.src = getImageUrl(card);
          mini.appendChild(img);
          const config = GAME_CONFIG[state.gameMode];
          if (card.rarity === 'rare' || card.rarity === 'holo' || card[config.chaseKey] || card.isChase) {
            mini.classList.add('rare-mini');
          }
          // Click to enlarge
          mini.addEventListener('click', (e) => {
            e.stopPropagation();
            showCardFromSheet(card);
          });
          mini.style.cursor = 'pointer';
        } else {
          mini.classList.add('empty');
          // Tap empty slot to speed reveal
          mini.addEventListener('click', (e) => {
            e.stopPropagation();
            revealNextFromSheet();
          });
          mini.style.cursor = 'pointer';
        }
        els.sheetCards.appendChild(mini);
      }
    }

    function revealNextFromSheet() {
      const nextIndex = state.revealed.length;
      if (nextIndex >= state.cards.length) return;

      // Reveal the next card
      const card = state.cards[nextIndex];
      const price = getPrice(card.name, card.rarity);
      card.price = price;

      state.currentIndex = nextIndex;
      state.packValue += price;
      state.revealed.push(card);

      // Update totals
      els.totalAmount.textContent = formatPrice(state.packValue);
      els.sheetValue.textContent = formatPrice(state.packValue);

      // Haptic feedback
      const config = GAME_CONFIG[state.gameMode];
      const isChase = card[config.chaseKey] || card.isChase;
      if (isChase) {
        haptic('power9');
      } else if (card.rarity === 'rare' || card.rarity === 'holo') {
        haptic('heavy');
      } else {
        haptic('light');
      }

      // Re-render the grid
      renderSheetCards();

      // Update progress dots
      updateProgressDots(nextIndex);

      // Also update the main card display for when they go back
      els.cardImg.src = getImageUrl(card);
      els.cardValue.textContent = formatPrice(price);
      preloadNextCard(nextIndex + 1);

      // Check if pack complete
      if (state.revealed.length >= state.cards.length) {
        state.packComplete = true;
        els.sheetTitle.textContent = 'Pack Complete!';
        els.btnNewPack.style.display = 'block';
        els.btnContinue.textContent = 'View Cards';
      }
    }

    function hideSheet() {
      state.sheetOpen = false;
      els.sheetBackdrop.classList.remove('visible');
      els.bottomSheet.classList.remove('open');
    }

    function startNewPack() {
      hideSheet();

      // Reset state
      state.packOpened = false;
      state.packComplete = false;
      state.isAnimating = false;

      // Reset UI - go back to pack screen (skip splash for subsequent packs)
      els.cardScreen.classList.remove('active');
      els.packScreen.classList.add('visible');
      els.packScreen.classList.remove('hidden');
      els.pack.classList.remove('tearing', 'pokemon-pack', 'fleer-pack');
      if (state.gameMode === 'pokemon') els.pack.classList.add('pokemon-pack');
      if (state.gameMode === 'fleer') els.pack.classList.add('fleer-pack');
      els.pack.style.transform = '';
      els.progressDots.classList.remove('visible');
      els.card.classList.remove('rare', 'power9', 'chase', 'pokemon-card', 'fleer-card');
      els.cardValue.classList.remove('visible');
      els.cardNext.style.visibility = 'hidden';
      els.cardNext.classList.remove('rare', 'power9', 'chase', 'peeking', 'pokemon-card', 'fleer-card');
      els.cardNext.style.transform = '';
      els.cardNext.style.filter = '';
      els.btnNewPack.style.display = 'none';
      els.btnContinue.textContent = 'Continue';
      els.totalValue.classList.remove('visible');
      els.totalAmount.textContent = '$0';
      els.swipeHint.classList.remove('visible');

      // Update pack image for current mode
      const config = GAME_CONFIG[state.gameMode];
      els.packImage.src = config.packArt;

      // Generate new pack
      initPack();
    }

    // ==================== CARD DETAILS ====================
    function showDetails() {
      if (state.currentIndex >= state.cards.length) return;
      const card = state.cards[state.currentIndex];
      showCardDetails(card);
    }

    function showCardFromSheet(card) {
      showCardDetails(card);
    }

    function showCardDetails(card) {
      state.detailsOpen = true;
      els.detailImg.src = getImageUrl(card);
      els.detailName.textContent = card.name;
      // Format rarity for display
      const config = GAME_CONFIG[state.gameMode];
      const isChase = card[config.chaseKey] || card.isChase;
      const rarityText = card.rarity ? card.rarity.charAt(0).toUpperCase() + card.rarity.slice(1) : 'Common';
      let rarityDisplay;
      if (isChase) {
        // For Pokemon, show "Chase Holo" etc; for MTG "Power 9"; for Fleer "Jordan RC"
        if (state.gameMode === 'pokemon') {
          rarityDisplay = `${config.chaseLabel} ${rarityText}`;
        } else {
          rarityDisplay = config.chaseLabel;
        }
      } else if (state.gameMode === 'fleer' && card.isSticker) {
        rarityDisplay = 'Sticker';
      } else {
        rarityDisplay = rarityText;
      }
      els.detailSet.textContent = rarityDisplay;
      els.detailPrice.textContent = formatPrice(card.price || getPrice(card.name, card.rarity));
      els.cardDetails.classList.add('visible');
    }

    function hideDetails() {
      state.detailsOpen = false;
      els.cardDetails.classList.remove('visible');
    }

    // ==================== TOUCH HANDLING ====================
    function handleTouchStart(e) {
      if (state.isAnimating || state.sheetOpen || state.detailsOpen) return;

      const touch = e.touches[0];
      state.touchStartX = touch.clientX;
      state.touchStartY = touch.clientY;
      state.touchCurrentX = touch.clientX;
      state.touchCurrentY = touch.clientY;
      state.touchStartTime = Date.now();
      state.isDragging = true;

      if (state.packOpened && !state.packComplete) {
        // Remove animation classes so drag transform works
        els.card.classList.remove('deal-normal', 'deal-rare', 'deal-power9');
        els.card.classList.add('dragging');

        // Hide swipe hint when user starts interacting
        els.swipeHint.classList.remove('visible');
      }
    }

    function handleSplashTouchEnd(e) {
      if (!state.showingSplash) return;

      const dx = state.touchCurrentX - state.touchStartX;
      const dy = state.touchCurrentY - state.touchStartY;
      const dt = Date.now() - state.touchStartTime;
      const isTap = Math.abs(dx) < 20 && Math.abs(dy) < 20 && dt < 400;

      // Check if tap was on the logo
      const touch = e.changedTouches[0];
      const tappedElement = document.elementFromPoint(touch.clientX, touch.clientY);
      const tappedLogo = tappedElement === els.splashLogo || els.splashLogo.contains(tappedElement);

      if (isTap) {
        if (tappedLogo) {
          // Tap on logo - switch mode
          switchGameMode();
        } else {
          // Tap elsewhere - dismiss splash
          dismissSplash();
        }
      }
    }

    function handleTouchMove(e) {
      if (!state.isDragging || state.isAnimating) return;

      const touch = e.touches[0];
      state.touchCurrentX = touch.clientX;
      state.touchCurrentY = touch.clientY;

      // Don't do anything while splash is showing
      if (state.showingSplash) return;

      const dx = state.touchCurrentX - state.touchStartX;
      const dy = state.touchCurrentY - state.touchStartY;

      if (!state.packOpened) {
        // Pack drag - only respond to up swipe
        if (dy < -20) {
          const progress = Math.min(1, Math.abs(dy) / 150);
          els.pack.style.transform = `translateY(${dy * 0.5}px) scale(${1 + progress * 0.05})`;
        }
      } else if (state.packComplete) {
        // Pack complete - show down indicator for summary
        els.indDown.classList.toggle('visible', dy > 50);
      } else if (state.currentIndex < state.cards.length) {
        // Card drag - follows finger exactly
        const rotation = dx * 0.08;
        els.card.style.transform = `translate(${dx}px, ${dy}px) rotate(${rotation}deg)`;

        // Calculate swipe progress for peek effect (0 to 1)
        const swipeDistance = Math.sqrt(dx * dx + dy * dy);
        const threshold = 120; // pixels for full peek
        const progress = Math.min(1, swipeDistance / threshold);

        // Update next card peek - reveals as you swipe
        updateNextCardPeek(progress);

        // Show indicators only on first card
        if (state.currentIndex === 0) {
          els.indRight.classList.toggle('visible', dx > 50);
          els.indUp.classList.toggle('visible', dy < -50);
          els.indDown.classList.toggle('visible', dy > 60);
        }
      }
    }

    function handleTouchEnd(e) {
      if (!state.isDragging) return;
      state.isDragging = false;

      // Handle splash screen separately
      if (state.showingSplash) {
        handleSplashTouchEnd(e);
        return;
      }

      const dx = state.touchCurrentX - state.touchStartX;
      const dy = state.touchCurrentY - state.touchStartY;
      const dt = Date.now() - state.touchStartTime;
      const velocity = Math.sqrt(dx * dx + dy * dy) / dt;
      const isTap = Math.abs(dx) < 10 && Math.abs(dy) < 10 && dt < 300;

      // Hide indicators
      els.indRight.classList.remove('visible');
      els.indUp.classList.remove('visible');
      els.indDown.classList.remove('visible');

      if (!state.packOpened) {
        // Check for pack tear
        if (dy < -80 || (dy < -50 && velocity > 0.5)) {
          tearOpenPack();
        } else {
          els.pack.style.transform = '';
        }
      } else if (state.packComplete) {
        // Pack complete - swipe down to see summary again
        if (dy > 50) {
          showSheet(true);
        }
      } else if (state.currentIndex < state.cards.length) {
        els.card.classList.remove('dragging');

        if (isTap) {
          // Tap to show details
          showDetails();
        } else if ((dx > 60 || (dx > 30 && velocity > 0.3)) ||
                   (dy < -60 || (dy < -30 && velocity > 0.3))) {
          // Swipe right or up - next card
          const dir = Math.abs(dx) > Math.abs(dy) ? 'right' : 'up';
          swipeCardOut(dir);
        } else if (dy > 80) {
          // Swipe down - show sheet
          showSheet(false);
          resetCardPosition();
        } else {
          // Reset - snap back
          resetCardPosition();
        }
      }
    }

    // ==================== EVENT LISTENERS ====================
    document.addEventListener('touchstart', handleTouchStart, { passive: true });
    document.addEventListener('touchmove', handleTouchMove, { passive: false });
    document.addEventListener('touchend', handleTouchEnd);

    // Prevent default behaviors
    document.addEventListener('touchmove', (e) => {
      if (state.isDragging) e.preventDefault();
    }, { passive: false });

    // Card details dismiss
    els.cardDetails.addEventListener('click', hideDetails);

    // Sheet interactions
    els.sheetBackdrop.addEventListener('click', hideSheet);
    els.btnContinue.addEventListener('click', hideSheet);
    els.btnNewPack.addEventListener('click', startNewPack);

    // Back link - return to splash
    els.backLink.addEventListener('click', (e) => {
      e.preventDefault();
      goBackToSplash();
    });

    // ==================== INIT ====================
    initPack();
  </script>
</body>
</html>
